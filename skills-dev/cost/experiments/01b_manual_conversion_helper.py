#!/usr/bin/env python3
"""
DWG è½¬æ¢è¾…åŠ©å·¥å…·

ç”±äº API ä¸æ”¯æŒ DWG è½¬æ¢ï¼Œè¿™ä¸ªè„šæœ¬å¸®åŠ©ä½ ï¼š
1. æ£€æµ‹ DWG æ–‡ä»¶ä¿¡æ¯
2. æä¾›è½¬æ¢å»ºè®®
3. ç­‰å¾…ä½ æ‰‹åŠ¨è½¬æ¢åï¼Œè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€æ­¥
"""

import sys
import os
import time


def detect_dwg_info(dwg_path):
    """æ£€æµ‹ DWG æ–‡ä»¶ä¿¡æ¯"""
    print("ğŸ“‹ DWG æ–‡ä»¶ä¿¡æ¯ï¼š")
    print(f"   è·¯å¾„: {dwg_path}")

    file_size = os.path.getsize(dwg_path)
    print(f"   å¤§å°: {file_size / 1024 / 1024:.2f} MB")

    # è¯»å–ç‰ˆæœ¬ä¿¡æ¯
    with open(dwg_path, 'rb') as f:
        header = f.read(6)
        version = header.decode('ascii', errors='ignore')
        print(f"   ç‰ˆæœ¬: {version}")

    return version


def suggest_conversion_methods():
    """å»ºè®®è½¬æ¢æ–¹æ³•"""
    print("\n" + "="*60)
    print("ğŸ”§ è½¬æ¢æ–¹æ³•å»ºè®®ï¼š")
    print("="*60)

    print("\nã€æ–¹æ³•1ã€‘åœ¨çº¿è½¬æ¢ï¼ˆæœ€å¿«ï¼‰")
    print("   1. æ‰“å¼€: https://www.zamzar.com/convert/dwg-to-dxf/")
    print("   2. ä¸Šä¼ ä½ çš„ DWG æ–‡ä»¶")
    print("   3. ä¸‹è½½è½¬æ¢åçš„ DXF æ–‡ä»¶")
    print("   4. ä¿å­˜åˆ°åŒä¸€ç›®å½•")

    print("\nã€æ–¹æ³•2ã€‘å¯¼å‡ºä¸ºå›¾ç‰‡ï¼ˆæ¨èç”¨äºè§†è§‰åˆ†æï¼‰")
    print("   å¦‚æœä½ æœ‰ AutoCAD æˆ– CAD æŸ¥çœ‹å™¨ï¼š")
    print("   1. æ‰“å¼€ DWG æ–‡ä»¶")
    print("   2. å¯¼å‡ºä¸º PNG/PDF")
    print("   3. ä¿å­˜åˆ°åŒä¸€ç›®å½•")

    print("\nã€æ–¹æ³•3ã€‘ODA File Converterï¼ˆæ‰¹é‡è½¬æ¢ï¼‰")
    print("   1. ä¸‹è½½: https://www.opendesign.com/guestfiles/oda_file_converter")
    print("   2. å®‰è£…åæ‰¹é‡è½¬æ¢")


def wait_for_conversion(dwg_path):
    """ç­‰å¾…ç”¨æˆ·å®Œæˆè½¬æ¢"""
    base_path = dwg_path.rsplit('.', 1)[0]

    print("\n" + "="*60)
    print("â³ ç­‰å¾…è½¬æ¢å®Œæˆ...")
    print("="*60)
    print(f"\nè¯·å°†è½¬æ¢åçš„æ–‡ä»¶ä¿å­˜ä¸ºï¼š")
    print(f"   DXF: {base_path}.dxf")
    print(f"   æˆ–")
    print(f"   PNG: {base_path}.png")
    print(f"\nå®ŒæˆåæŒ‰ Enter ç»§ç»­ï¼Œæˆ–è¾“å…¥ 'skip' è·³è¿‡")

    input("\næŒ‰ Enter ç»§ç»­...")

    # æ£€æŸ¥è½¬æ¢ç»“æœ
    dxf_path = base_path + '.dxf'
    png_path = base_path + '.png'
    pdf_path = base_path + '.pdf'

    if os.path.exists(dxf_path):
        print(f"\nâœ… æ‰¾åˆ° DXF æ–‡ä»¶: {dxf_path}")
        print(f"\nä¸‹ä¸€æ­¥: è¿è¡Œå®éªŒ2è¯»å– DXF")
        print(f"   python 02_read_cad.py \"{dxf_path}\"")
        return dxf_path, 'dxf'

    elif os.path.exists(png_path):
        print(f"\nâœ… æ‰¾åˆ° PNG æ–‡ä»¶: {png_path}")
        print(f"\nä¸‹ä¸€æ­¥: è¿è¡Œå®éªŒ4è§†è§‰åˆ†æ")
        print(f"   python 04_vision_analysis.py \"{png_path}\"")
        return png_path, 'png'

    elif os.path.exists(pdf_path):
        print(f"\nâœ… æ‰¾åˆ° PDF æ–‡ä»¶: {pdf_path}")
        print(f"\nä¸‹ä¸€æ­¥: è¿è¡Œå®éªŒ4è§†è§‰åˆ†æ")
        print(f"   python 04_vision_analysis.py \"{pdf_path}\"")
        return pdf_path, 'pdf'

    else:
        print("\nâš ï¸  æœªæ‰¾åˆ°è½¬æ¢åçš„æ–‡ä»¶")
        print("   è¯·ç¡®ä¿æ–‡ä»¶ä¿å­˜åœ¨åŒä¸€ç›®å½•ä¸‹")
        return None, None


def main():
    if len(sys.argv) < 2:
        print("ç”¨æ³•: python 01b_manual_conversion_helper.py <DWGæ–‡ä»¶è·¯å¾„>")
        return

    dwg_path = sys.argv[1]

    if not os.path.exists(dwg_path):
        print(f"âŒ æ–‡ä»¶ä¸å­˜åœ¨: {dwg_path}")
        return

    print("\n" + "="*60)
    print("ğŸ” DWG è½¬æ¢è¾…åŠ©å·¥å…·")
    print("="*60 + "\n")

    # æ£€æµ‹æ–‡ä»¶ä¿¡æ¯
    detect_dwg_info(dwg_path)

    # å»ºè®®è½¬æ¢æ–¹æ³•
    suggest_conversion_methods()

    # ç­‰å¾…è½¬æ¢
    result_path, file_type = wait_for_conversion(dwg_path)

    if result_path:
        print(f"\nğŸ‰ å‡†å¤‡å°±ç»ªï¼å¯ä»¥ç»§ç»­å®éªŒäº†")


if __name__ == "__main__":
    main()
