# Real-Time Progress Tracking UI Mockup

## 方案 A: 聊天界面内嵌进度显示

```
┌─────────────────────────────────────────────────────────────────┐
│  💬 GauzAssist Chat                                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  User: 你好，请介绍一下你自己                                      │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 🔄 正在处理... (请求 #a3f2)                                 │ │
│  │                                                             │ │
│  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │ │
│  │ 主流程 (同步)                                    [3/7 完成] │ │
│  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │ │
│  │                                                             │ │
│  │ ✅ 初始化会话                                      0.12s    │ │
│  │ ✅ 检查对话压缩                                    0.05s    │ │
│  │ ✅ 生成查询向量                                    0.89s    │ │
│  │ ⏳ LLM过滤技能和记忆                              8.2s...  │ │
│  │    ├─ 🔄 并行: GauzMem召回                       15.3s...  │ │
│  │ ⏸️  准备工具和Prompt                              等待中    │ │
│  │ ⏸️  LLM生成响应                                   等待中    │ │
│  │                                                             │ │
│  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │ │
│  │ 后台任务 (异步)                                             │ │
│  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │ │
│  │                                                             │ │
│  │ ⏸️  GauzMem存储                                   等待响应   │ │
│  │                                                             │ │
│  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │ │
│  │                                                             │ │
│  │ 总耗时: 24.6s / 预计 ~35s                                   │ │
│  │                                                             │ │
│  │ [⏸️ 暂停] [❌ 取消]                                         │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 输入消息...                                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│  [发送]                                                         │
└─────────────────────────────────────────────────────────────────┘
```

## 方案 B: Dashboard 实时监控

```
┌─────────────────────────────────────────────────────────────────┐
│  📊 仪表盘                                                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  🔴 正在进行的请求 (1)                                           │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 请求 #a3f2 - "你好，请介绍一下你自己"                        │ │
│  │ 开始时间: 14:23:15  |  已运行: 24.6s                        │ │
│  │                                                             │ │
│  │ 主流程进度: ████████████░░░░░░░░░░ 57% (4/7)               │ │
│  │                                                             │ │
│  │ 时间线视图:                                                  │ │
│  │ ┌─────────────────────────────────────────────────────┐   │ │
│  │ │ 0s    5s    10s   15s   20s   25s   30s   35s   40s │   │ │
│  │ │ ├─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┤   │   │ │
│  │ │                                                       │   │ │
│  │ │ 主流程:                                                │   │ │
│  │ │ ██▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░░░░░░░░░░░░░░░░░░░   │   │ │
│  │ │ │ │  │        │                                      │   │ │
│  │ │ │ │  │        └─ ⏳ LLM过滤 (8.2s...)               │   │ │
│  │ │ │ │  └─ ✅ 生成向量 (0.89s)                          │   │ │
│  │ │ │ └─ ✅ 检查压缩 (0.05s)                             │   │ │
│  │ │ └─ ✅ 初始化 (0.12s)                                 │   │ │
│  │ │                                                       │   │ │
│  │ │ 并行任务:                                              │   │ │
│  │ │    ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░░░░░░░░░░   │   │ │
│  │ │    └─ 🔄 GauzMem召回 (15.3s...)                     │   │ │
│  │ │                                                       │   │ │
│  │ │ 后台任务:                                              │   │ │
│  │ │                                      ░░░░░░░░░░░░░░   │   │ │
│  │ │                                      └─ ⏸️ GauzMem存储│   │ │
│  │ └─────────────────────────────────────────────────────┘   │ │
│  │                                                             │ │
│  │ 详细步骤:                                                    │ │
│  │ ✅ 初始化会话                    0.12s  ████████████████   │ │
│  │ ✅ 检查对话压缩                  0.05s  ████████████████   │ │
│  │ ✅ 生成查询向量                  0.89s  ████████████████   │ │
│  │ ⏳ LLM过滤技能和记忆            8.2s... ████████████░░░░   │ │
│  │   └─ 🔄 GauzMem召回 (并行)    15.3s... ██████████░░░░░░   │ │
│  │ ⏸️  准备工具和Prompt                    ░░░░░░░░░░░░░░░░   │ │
│  │ ⏸️  LLM生成响应                         ░░░░░░░░░░░░░░░░   │ │
│  │                                                             │ │
│  │ [❌ 取消请求] [⏸️ 暂停] [🔄 强制刷新]                       │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ✅ 已完成的请求 (5)                                             │
│  [展开/折叠]                                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 方案 C: 混合方案（推荐）

```
┌─────────────────────────────────────────────────────────────────┐
│  💬 聊天                                                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  User: 你好，请介绍一下你自己                                      │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 🔄 正在思考... (24.6s)                                      │ │
│  │                                                             │ │
│  │ 主流程: ████████████░░░░░░░░░░ 57% (4/7)                   │ │
│  │ ⏳ 当前: LLM过滤技能和记忆 (8.2s...)                         │ │
│  │ 🔄 并行: GauzMem召回 (15.3s...)                             │ │
│  │                                                             │ │
│  │ 💡 提示: 可以在仪表盘查看详细进度                             │ │
│  │                                                             │ │
│  │ [查看详情] [取消]                                            │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 输入消息...                                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│  [发送]                                                         │
└─────────────────────────────────────────────────────────────────┘

点击 [查看详情] 后跳转到 Dashboard 的详细视图
```

## 超时处理 UI

```
┌───────────────────────────────────────────────────────────┐
│ ⚠️  检测到长时间运行的步骤                                  │
│                                                           │
│ GauzMem召回已运行 102.5s (超过预期 30s)                    │
│                                                           │
│ 可能的原因:                                                │
│ • GauzMem 服务响应缓慢                                     │
│ • 网络连接问题                                             │
│ • 查询复杂度较高                                           │
│                                                           │
│ 建议操作:                                                  │
│ [⏳ 继续等待] [⏭️ 跳过此步骤] [❌ 取消整个请求]            │
│                                                           │
│ 如果跳过，将使用本地记忆继续处理                            │
└───────────────────────────────────────────────────────────┘
```

## 移动端适配方案

```
┌─────────────────────┐
│  💬 GauzAssist      │
├─────────────────────┤
│                     │
│  User: 你好...      │
│                     │
│  ┌───────────────┐  │
│  │ 🔄 处理中     │  │
│  │               │  │
│  │ ████░░░░ 57%  │  │
│  │               │  │
│  │ ⏳ LLM过滤    │  │
│  │ 🔄 GauzMem    │  │
│  │               │  │
│  │ 24.6s / ~35s  │  │
│  │               │  │
│  │ [详情] [取消] │  │
│  └───────────────┘  │
│                     │
│  ┌───────────────┐  │
│  │ 输入...       │  │
│  └───────────────┘  │
│  [发送]             │
└─────────────────────┘
```

---

## 技术实现要点

### 1. 前端轮询机制
```python
# Gradio 实现
def get_current_progress():
    """获取当前正在进行的请求进度"""
    active_requests = PerformanceTracker.get_active_requests()
    if not active_requests:
        return None

    req = active_requests[0]  # 假设同时只有一个请求
    return {
        "request_id": req.request_id,
        "query": req.user_query,
        "elapsed": time.time() - req.start_time,
        "sync_progress": calculate_sync_progress(req),
        "current_step": get_current_step(req),
        "parallel_steps": get_parallel_steps(req)
    }

# 在 Gradio 中使用 gr.Timer 实现自动刷新
with gr.Tab("💬 聊天"):
    progress_display = gr.Markdown(visible=False)

    # 每 2 秒刷新一次进度
    timer = gr.Timer(value=2, active=True)
    timer.tick(
        fn=update_progress_display,
        outputs=progress_display
    )
```

### 2. 后端状态管理
```python
class PerformanceTracker:
    @classmethod
    def get_active_requests(cls) -> List[RequestBlock]:
        """获取正在进行的请求"""
        return [req for req in cls._all_requests if req.status == "processing"]

    @classmethod
    def get_current_step(cls, request_id: str) -> Optional[Step]:
        """获取当前正在执行的步骤"""
        for req in cls._all_requests:
            if req.request_id == request_id:
                # 找到最后一个 in_progress 的步骤
                for step in reversed(req.sync_steps):
                    if step.status == "in_progress":
                        return step
        return None
```

### 3. 超时检测
```python
class PerformanceTracker:
    TIMEOUT_THRESHOLDS = {
        "GauzMem召回": 30.0,  # 30秒
        "LLM过滤技能和记忆": 15.0,
        "LLM生成响应": 20.0
    }

    def check_timeout(self, step: Step) -> bool:
        """检查步骤是否超时"""
        if step.status != "in_progress":
            return False

        threshold = self.TIMEOUT_THRESHOLDS.get(step.name, 60.0)
        elapsed = time.time() - step.start_time
        return elapsed > threshold
```

---

## 我的 UX 建议

基于以上 mockup，我的推荐方案是：

### 🎯 最优方案: **方案 C (混合方案)**

#### 理由:

1. **聊天界面 - 简洁进度条**
   - ✅ 不打断对话流
   - ✅ 提供基本反馈（用户知道系统在工作）
   - ✅ 显示关键信息（当前步骤、进度百分比、耗时）
   - ✅ 提供"查看详情"入口，满足高级用户需求

2. **Dashboard - 详细监控**
   - ✅ 完整的时间线视图（泳道图）
   - ✅ 所有步骤的详细耗时
   - ✅ 历史请求对比
   - ✅ 性能分析工具

3. **刷新频率: 2秒**
   - ✅ 足够实时（用户不会觉得卡住）
   - ✅ 不会过度消耗资源
   - ✅ 可配置（高级设置中提供 1s/2s/5s 选项）

4. **超时处理: 智能提示 + 用户选择**
   - ✅ 超过预期时间 2 倍后显示警告
   - ✅ 提供三个选项：继续等待 / 跳过步骤 / 取消请求
   - ✅ 默认行为：继续等待（不强制中断）
   - ✅ 跳过步骤时使用降级方案（如跳过 GauzMem，使用本地记忆）

5. **取消按钮: 必须有**
   - ✅ 用户可能输错问题，需要重新开始
   - ✅ 超时时可以快速放弃
   - ✅ 取消后清理资源（停止后台任务）

#### 实现优先级:

**Phase 1 (MVP):**
- [ ] 聊天界面简洁进度条
- [ ] 基本的步骤状态显示
- [ ] 取消按钮

**Phase 2:**
- [ ] Dashboard 详细视图
- [ ] 时间线泳道图
- [ ] 超时检测和提示

**Phase 3:**
- [ ] 可配置刷新频率
- [ ] 跳过步骤功能
- [ ] 移动端适配

---

## 关键设计原则

1. **渐进式披露 (Progressive Disclosure)**
   - 聊天界面只显示必要信息
   - 详细信息放在 Dashboard
   - 用户可以按需深入

2. **非阻塞体验**
   - 进度显示不影响继续输入新消息
   - 后台任务不阻塞界面响应

3. **清晰的视觉层次**
   - 主流程 vs 并行任务 vs 后台任务
   - 用不同的视觉样式区分

4. **可操作性**
   - 提供取消、暂停等控制选项
   - 超时时给出明确的建议

5. **性能友好**
   - 2秒轮询不会造成性能问题
   - 只追踪活跃请求，历史请求不实时更新

---

你觉得这个方案如何？我可以开始实现 Phase 1 的功能。
